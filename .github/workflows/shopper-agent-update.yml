name: Shopper Agent Update

on:
    push:
        branches: [main, develop]
        paths:
            - "src/app/agents/shopperAgent_initializer.py"
            - "src/prompts/ShopperAgentPrompt.txt"
    pull_request:
        branches: [main]
        paths:
            - "src/app/agents/shopperAgent_initializer.py"
            - "src/prompts/ShopperAgentPrompt.txt"

jobs:
    update-shopper-agent:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Cache pip dependencies
              uses: actions/cache@v3
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('src/requirements.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r src/requirements.txt

            - name: Azure Login
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Run Shopper Agent Initializer
              env:
                  # Azure AI Project settings
                  AZURE_AI_AGENT_ENDPOINT: ${{ secrets.AZURE_AI_AGENT_ENDPOINT }}
                  AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME: ${{ secrets.AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME }}

                  # Shopper Agent (Cora) ID
                  cora: ${{ secrets.CORA_AGENT_ID }}

                  # Azure Authentication settings
                  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
                  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
                  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
                  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

                  # Set to use DefaultAzureCredential for CI/CD
                  IS_LOCAL_AUTH: "false"

              run: |
                  cd src/app/agents
                  python shopperAgent_initializer.py

            - name: Verify agent update
              run: |
                  echo "‚úÖ Shopper Agent (Cora) has been updated successfully"
                  echo "üîÑ Triggered by changes to:"
                  echo "   - shopperAgent_initializer.py"
                  echo "   - ShopperAgentPrompt.txt"

            - name: Report status
              if: failure()
              run: |
                  echo "‚ùå Shopper Agent (Cora) update failed"
                  echo "Please check the logs above for error details"
                  exit 1
